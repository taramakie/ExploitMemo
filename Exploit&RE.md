# Exploit&Reversing
[Nightmare](https://github.com/guyinatuxedo/nightmare)を解きながらExploitに役立ちそうなことを自分用にメモ。
## コマンド
### file
ビット数、エンディアン、アーキテクチャ、ライブラリのリンクは動的か静的か、シンボルの有無を確認する。
### pwn checksec
アーキテクチャやRELRO、Stack Canary、NX、PIEといったエクスプロイトへの緩和策の有無を確認できる。
### ROPgadget
[ROPのガジェットを列挙できるPythonツール](https://github.com/JonathanSalwan/ROPgadget)。「`ROPgadget --binary [バイナリ]`」で列挙できる。
### one_gadget
一発で`execve("/bin/sh")`を呼び出すガジェットを見つけてくる。[詳細](https://github.com/david942j/one_gadget)。内部の動作としてはシンボリック実行でワンガジェットを見つけている。
### gef
#### search-pattern
バイナリ中に出てくるアドレスをサーチする
### objdump
#### Dオプション
ディスアセンブル結果を出力する。
#### Rオプション
Relocation情報を出力する。主にGOTの情報を見るときに使う。
#### jオプション
表示したいセクションを指定する。`-j .plt`のような感じ。
### strings
#### oオプション
入力の先頭からのオフセットを10進数で表示する。16進数などで表示したい場合は後述のtオプションを使う。
#### tオプション
検出した文字列の位置を8、10、16進数の形式で表示できる。それぞれo、d、xをtオプションに対して指定する必要がある(16進数の場合`-tx`)。
### TheNight
二か所のメモリリークからLIBCのバージョンを特定するツール([GitHub](https://github.com/guyinatuxedo/The_Night))
### libc-database
関数名とそのアドレスからLibcのバージョン情報を特定できる([GitHub](https://github.com/niklasb/libc-database.git))([Web版のURL](https://libc.blukat.me))
### patchelf
ELFバイナリにパッチを行うためのツール
### ropper
ROPガジェットを探すのに使えるツール。うまくいくとROPを行うためのPythonコードを吐いてくれる([GitHub](https://github.com/sashs/Ropper))
### HeapME
ヒープの解析が楽になるツール([Web版(会員登録が必要)](https://heapme.f2tc.com/login))

## Python
### 生のバイナリをプリントする
sys.stdout.bufferのwriteを使うとPython 3系で生のバイナリをプリントできる。
```
import sys; sys.stdout.buffer.write(b"\xde\xad\xbe\xef")
```
### 数値をバイトに変換する
`to_bytes`メソッドを使う。第一引数にバイトのサイズ、第二引数にエンディアンを指定する。
### 数値の文字形式への変換でゼロ埋めを行う
`format`を使う。第一引数に変換したい数値、第二引数にフォーマットの形式を指定する。数値をアスキーコードなどに変換する場合decodeメソッドを使う。
### pwnを使ってPLTやGOTのアドレスを調べる
```
from pwn import *
elf = ELF(読み込みたいファイルパス)
print(hex(elf.symbols['puts'])) #putsのPLTのアドレスを表示する
print(hex(elf.got['puts']))     #putsのGOTのアドレスを表示する
```

## 危険な関数
### gets
NewLineやEOFが入力されるまで入力値を受け取るため、bofの可能性がある関数。メモリへの読み込み時に改行文字はNULL文字になる。
### scanf
フォーマットストリングで入力される文字数を制限しないとオーバーフローする可能性がある。
### memcpy
第三引数に指定できる値によってはbofの可能性がある。

## エラーとその回避策
### System関数のアラインメントのエラー
system関数内の以下のようなところでSIGSEGVエラーが出る時がある。原因はアラインメントの問題で16バイトにそろえてやる必要がある。
```
0x7fbc2ff54e3c <do_system+364>  movaps XMMWORD PTR [rsp+0x50], xmm0
```
なんとかスタックのバイトを8バイトずらす必要がある。最初からやっているとNightmareでは[Warmup](https://guyinatuxedo.github.io/05-bof_callfunction/csaw16_warmup/index.html)でこの問題にぶつかるはず。ジャンプ先のアドレスを0x40060eにして「`push rbp`」を飛ばすことで回避した。[このブログ記事](https://smallkirby.hatenablog.com/entry/2019/08/23/223507)のように、retに飛ぶROPを目的とするジャンプ先の前に入れても解決できるはず。

## セキュリティ機構とその回避
### ASLR&PIE
#### ASLR
スタックやヒープ、libcなどの領域がある程度ランダムになる。コード領域はそのまま。オフセットは変化しないので、メモリの一部をリークさせれば、それから計算してバイパス可能。具体的な方法としては次のような方法が考えられる。
- putsやprintfの引数に渡される変数をオーバーフローで書き換えてGOTのputsやprintfのアドレスを漏えいさせる。オフセットは変わらないので漏えいしたアドレスからlibcのベースアドレスを計算でき、libcで使われている他の関数のアドレスがわかる。ただしPIEが有効になっていると実行ファイルのGOTのアドレスもランダムになるので、先に実行ファイルのアドレスをリークさせる必要がある。逆に言えばPIEが無効であれば、インポートしている関数のアドレスを格納するGOTは固定のアドレスなので、特定は容易に可能。
- 32bitのプログラムであればNOP SLEDでブルートフォースすることでバイパスすることも可能。
#### PIE
PIE(Position Independent Executable)はコード領域がランダム化できるようにcall命令やjmp命令が絶対アドレスではなく、相対アドレスで指定される。PIEでは通常の方法でブレークポイントをセットできないが、gefでは「`pie b *[アドレス]`」でブレークポイントをセットし、「`pie run`」で実行することでブレークポイントが有効な状態で実行することができる。回避方法は基本的にASLRと同じ。
### NXビット/DEP
スタックやヒープなどのデータを格納する領域でのデータ実行を無効にする。ROPやret2libcでバイパスできる。
### Stack canary
回避方法はcanaryの漏えいかブルートフォース。ブルートフォースの場合、親プロセスと子プロセスでcanaryが変化しない性質を利用するパターンがある。Linuxの場合、最下位バイトは0x00になる(gccではそうだが、コンパイラやバージョンによるかも)。Visual Studioでは0x00にならない。またVisual Studioの場合、spとXORを取る。
### Relro(Read Only Relocation)
NXと同様メモリの権限を設定する。具体的にはGOTテーブルをリードオンリーにすることでGOTオーバーライトのような攻撃を防御可能にする。GOTテーブルはlazy bindingを行うために利用されるメモリ領域で関数のアドレスを保持する。

## Format String Bug
Format String Bugでは問題となる関数のあとに呼ばれる関数のGOTアドレスを書き換えて、制御を奪うという方法がある。ただ問題となる関数のあとに関数が呼ばれない場合でも.fini_arrayを書き換えることで攻撃者の意図した関数を呼ぶことが可能。

## その他参考資料
- [シェルコードまとめ](http://shell-storm.org/shellcode/index.html)
- [x64システムコールのレジスタの設定値](https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/)
- [x86システムコールのレジスタ設定値](https://en.wikibooks.org/wiki/X86_Assembly/Interfacing_with_Linux)
- [x86システムコールの番号](https://x86.syscall.sh/)
- [Ghidraの設定](https://securelist.com/how-to-train-your-ghidra/108272/)
